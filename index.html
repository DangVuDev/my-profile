<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketMedia NFT Marketplace - LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        // C·∫•u h√¨nh Tailwind CSS m·ªü r·ªông
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': '#0f0f1e', // M√†u n·ªÅn ch√≠nh
                        'card': '#1a1a2e', // M√†u n·ªÅn th·∫ª/modal
                        'accent': '#16213e', // M√†u ph·ª•, n·ªÅn input
                        'neon-blue': '#00d4ff',
                        'neon-cyan': '#00ffea',
                        'neon-pink': '#ff2e96',
                        'neon-green': '#39ff14',
                        'border-glow': '#2a2a4a', // M√†u border ph·ª•
                        'danger-red': '#ff4757', // M√†u cho h·ªßy/k·∫øt th√∫c l·ªói
                    },
                    fontFamily: {
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    boxShadow: {
                        'neon': '0 0 15px rgba(0, 212, 255, 0.5)',
                        'neon-pink': '0 0 15px rgba(255, 46, 150, 0.5)',
                        'neon-green': '0 0 15px rgba(57, 255, 20, 0.5)',
                        'card': '0 10px 30px rgba(0, 0, 0, 0.5)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            font-family: 'Roboto Mono', monospace;
            min-height: 100vh;
        }
        /* T√πy ch·ªânh Scrollbar cho theme t·ªëi */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f1e; }
        ::-webkit-scrollbar-thumb { background: #00d4ff; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00ffea; }

        /* Hi·ªáu ·ª©ng th·∫ª NFT */
        .nft-card {
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border-width: 1px; /* ƒê·∫£m b·∫£o border-glow ho·∫°t ƒë·ªông */
        }
        .nft-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3);
            border-color: #00d4ff;
        }
        .nft-card:hover .nft-image {
            transform: scale(1.05);
        }
        .nft-image {
            transition: transform 0.4s ease;
        }

        /* Hi·ªáu ·ª©ng N√∫t Neon */
        .btn-neon {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .btn-neon::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .btn-neon:hover::after {
            left: 100%;
        }

        .tag {
            border: none; /* B·ªè border n·∫øu ƒë√£ c√≥ m√†u n·ªÅn r√µ r√†ng */
            text-transform: uppercase;
        }
        .page-content.hidden {
            display: none;
        }
    </style>
</head>
<body class="text-white bg-bg-dark">

    <div id="loading-overlay" class="fixed inset-0 bg-black/90 flex-col items-center justify-center z-[9999] hidden">
        <div class="w-16 h-16 border-4 border-t-neon-cyan border-r-transparent border-b-neon-blue border-l-transparent rounded-full animate-spin mb-6"></div>
        <p class="text-neon-cyan text-lg font-medium">ƒêang ch·ªù x√°c nh·∫≠n giao d·ªãch Metamask...</p>
    </div>

    <header class="sticky top-0 z-50 backdrop-blur-lg bg-bg-dark/80 border-b border-border-glow shadow-neon">
    <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-neon-pink to-neon-cyan bg-clip-text text-transparent">
            MarketMedia
        </h1>

        <nav class="hidden md:flex space-x-8 text-lg">
            <button onclick="showPage('explore')" id="nav-explore" class="nav-item text-neon-cyan transition hover:text-neon-cyan">üåê Marketplace</button>
            <button onclick="showPage('mint')" id="nav-mint" class="nav-item hover:text-neon-cyan transition">üî® Mint NFT</button>
            <button onclick="showPage('profile')" id="nav-profile" class="nav-item hover:text-neon-cyan transition">üë§ Profile</button>
            <button onclick="showPage('admin')" id="nav-admin" class="nav-item hover:text-neon-cyan transition">üëë Admin</button>
        </nav>

        <div class="flex items-center gap-4">

            <div id="wallet-info" class="hidden bg-accent/70 border border-neon-green px-4 py-2 rounded-lg text-sm">
                <div id="account-display" class="font-mono text-neon-green font-bold"></div>
                <div id="balance-display" class="text-gray-400 text-xs mt-1"></div>
            </div>

            <button id="connect-wallet-btn" onclick="connectWallet()" 
                class="btn-neon bg-gradient-to-r from-neon-blue to-neon-cyan px-6 py-3 rounded-lg font-bold text-card shadow-neon hover:shadow-neon-green transition">
                K·∫øt N·ªëi V√≠
            </button>
            
            <button id="menu-toggle-btn" class="md:hidden text-2xl text-neon-cyan p-2" onclick="toggleMobileMenu()">
                &#9776; </button>
        </div>
    </div>
    
    <div id="mobile-menu-drawer" class="md:hidden hidden border-t border-border-glow py-4 px-6 bg-bg-dark/90">
        <nav class="flex flex-col space-y-3 text-lg">
            <button onclick="showPage('explore'); toggleMobileMenu()" class="nav-item-mobile text-neon-cyan transition hover:text-neon-cyan text-left w-full p-2 rounded">üåê Marketplace</button>
            <button onclick="showPage('mint'); toggleMobileMenu()" class="nav-item-mobile hover:text-neon-cyan transition text-left w-full p-2 rounded">üî® Mint NFT</button>
            <button onclick="showPage('profile'); toggleMobileMenu()" class="nav-item-mobile hover:text-neon-cyan transition text-left w-full p-2 rounded">üë§ Profile</button>
            <button onclick="showPage('admin'); toggleMobileMenu()" class="nav-item-mobile hover:text-neon-cyan transition text-left w-full p-2 rounded">üëë Admin</button>
        </nav>
    </div>
</header>

    <main class="max-w-7xl mx-auto px-6 py-10">

        <section id="explore-page" class="page-content">
            <h2 class="text-4xl font-bold text-neon-pink mb-8 border-b-2 border-neon-pink pb-4 inline-block">üåê NFT Marketplace</h2>
            <div id="explore-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                </div>
            <div class="text-center mt-12">
                <button id="load-more-btn" onclick="loadMoreNFTs()" class="btn-neon bg-neon-blue px-8 py-4 rounded-lg font-bold text-card shadow-neon hover:shadow-neon-green transition">
                    T·∫£i th√™m
                </button>
            </div>
        </section>

        <section id="mint-page" class="page-content hidden max-w-2xl mx-auto">
            <h2 class="text-4xl font-bold text-neon-pink mb-8 text-center">üî® Mint NFT M·ªõi</h2>
            <form id="mint-form" class="bg-card/70 backdrop-blur border border-border-glow rounded-2xl p-8 shadow-neon">
                <div class="mb-6">
                    <label class="block text-neon-cyan mb-2">T√™n NFT</label>
                    <input type="text" id="nft-title" required class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" placeholder="V√≠ d·ª•: Cyber Dragon #001">
                </div>
                <div class="mb-8">
                    <label class="block text-neon-cyan mb-2">ƒê∆∞·ªùng d·∫´n h√¨nh ·∫£nh (URL/IPFS)</label>
                    <input type="url" id="nft-image" required class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" placeholder="https://ipfs.io/ipfs/...">
                </div>
                <button type="submit" class="w-full btn-neon bg-gradient-to-r from-neon-pink to-neon-cyan py-5 rounded-lg font-bold text-card text-xl shadow-neon-pink hover:shadow-neon hover:scale-105 transition">
                    Mint NFT Ngay
                </button>
            </form>
        </section>

        <section id="profile-page" class="page-content hidden">
            <h2 class="text-4xl font-bold text-neon-pink mb-8">üë§ NFT C·ªßa T√¥i</h2>
            <p class="mb-6 text-lg">ƒê·ªãa ch·ªâ v√≠: <span id="profile-address" class="text-neon-green font-mono font-bold">Ch∆∞a k·∫øt n·ªëi</span></p>

            <div id="return-info" class="hidden bg-accent/70 border border-neon-green p-6 rounded-xl mb-8 flex items-center justify-between">
                <p>B·∫°n c√≥ <span id="pending-return-amount" class="text-2xl font-bold text-neon-green">0.0</span> ETH c√≥ th·ªÉ r√∫t</p>
                <button onclick="withdrawPendingReturns()" class="btn-neon bg-neon-green px-6 py-3 rounded-lg font-bold text-card shadow-neon-green hover:scale-105 transition">R√∫t ETH</button>
            </div>

            <div id="profile-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
        </section>

        <section id="admin-page" class="page-content hidden">
            <h2 class="text-4xl font-bold text-neon-pink mb-8">üëë Qu·∫£n L√Ω Ph√≠</h2>
            <div class="bg-card/70 backdrop-blur border border-border-glow rounded-2xl p-8 max-w-md mx-auto text-center">
                <p class="text-lg mb-4">Ph√≠ t√≠ch l≈©y: <span id="admin-fees-amount" class="text-3xl font-bold text-neon-pink">0.0</span> ETH</p>
                <button onclick="withdrawFees()" class="btn-neon bg-gradient-to-r from-neon-pink to-neon-cyan px-10 py-5 rounded-lg font-bold text-card text-xl shadow-neon-pink hover:scale-110 transition">
                    R√∫t T·∫•t C·∫£ Ph√≠
                </button>
            </div>
        </section>
    </main>

    <div id="nftDetailModal" class="fixed inset-0 bg-black/90 backdrop-blur-lg hidden items-center justify-center z-[1000] p-4">
        <div class="bg-card border border-neon-blue rounded-2xl max-w-5xl w-full max-h-[95vh] overflow-y-auto shadow-2xl animate-fade-in">
            <div class="sticky top-0 bg-card/90 backdrop-blur border-b border-border-glow p-6 flex justify-between items-center">
                <h2 id="modalTitle" class="text-3xl font-bold text-neon-pink"></h2>
                <button onclick="closeModal('nftDetailModal')" class="text-4xl text-gray-400 hover:text-neon-pink transition">&times;</button>
            </div>

            <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div>
                    <img id="modalImage" src="" alt="NFT" class="nft-image w-full rounded-xl border-2 border-neon-blue/50 shadow-neon object-cover">
                </div>

                <div class="flex flex-col justify-between">
                    <div>
                        <div class="grid grid-cols-2 gap-4 mb-8 text-lg">
                            <div><span class="text-gray-400">Token ID:</span> <span id="modalTokenId" class="font-bold text-neon-cyan"></span></div>
                            <div><span class="text-gray-400">Ch·ªß s·ªü h·ªØu:</span> <span id="modalOwner" class="font-bold text-neon-pink"></span></div>
                            <div><span class="text-gray-400">Gi√° b√°n cu·ªëi:</span> <span id="modalLastPrice" class="text-gray-300"></span></div>
                        </div>

                        <div class="bg-accent/50 border border-border-glow rounded-xl p-6 mb-8">
                            <div class="flex justify-between items-center mb-3">
                                <span id="modalStatus" class="tag px-4 py-2 rounded-full text-card font-bold"></span>
                                <span id="modalTimeRemaining" class="text-neon-cyan font-medium"></span>
                            </div>
                            <p id="modalCurrentPrice" class="text-5xl font-extrabold text-neon-green">0.0 ETH</p>
                        </div>

                        <div id="modalActions" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                        <div id="modalAuctionDetails" class="mt-8 bg-accent/30 border border-neon-blue/30 rounded-xl p-5 hidden">
                            <h4 class="text-xl font-bold text-neon-blue mb-4">Chi Ti·∫øt ƒê·∫•u Gi√°</h4>
                            <p class="mb-2">Highest Bidder: <span id="modalHighestBidder" class="text-neon-green font-bold"></span></p>
                            <p>K·∫øt th√∫c: <span id="modalEndTime" class="text-gray-300"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 bg-black/90 backdrop-blur-lg hidden items-center justify-center z-[1001] p-4">
        <div class="bg-card border border-neon-pink rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl animate-fade-in">
            <div class="sticky top-0 bg-card/90 backdrop-blur border-b border-border-glow p-6 flex justify-between items-center">
                <h2 id="actionModalTitle" class="text-3xl font-bold text-neon-cyan"></h2>
                <button onclick="closeModal('actionModal')" class="text-4xl text-gray-400 hover:text-neon-cyan transition">&times;</button>
            </div>
            <div id="actionModalContent" class="p-8">
                </div>
        </div>
    </div>
    
    <div id="message-box" class="fixed bottom-8 right-8 px-6 py-4 rounded-lg font-bold text-card shadow-2xl z-[1100] hidden animate-pulse">
        Notification
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
    // ====================== C·∫§U H√åNH & H·∫∞NG S·ªê ======================
    const CONTRACT_ADDRESS = "0x206af0d581a4B269BF8D6f4b239d8E1484755aD8";
    const PUBLIC_RPC_URL = 'https://bsc-dataseed1.binance.org/';

    
    // *** C·∫¶N THAY TH·∫æ ABI TH·ª∞C T·∫æ C·ª¶A B·∫†N ***
    const MARKET_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [],
		"name": "AlreadyListed",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "AuctionEnded",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "AuctionNotEnded",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "BidTooLow",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "CannotBuyOwnToken",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "DurationTooShort",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "ETHTransferFailed",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "ExactPriceRequired",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "FeeWithdrawalFailed",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "ImageRequired",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "InvalidAddress",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "LimitMustBePositive",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "NoFundsAvailable",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "NotApproved",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "NotListedForAuction",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "NotListedForFixedPrice",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "NotOwnerToken",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "OnlyOwnerRequest",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "PageStartFromOne",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "PriceMustBePositive",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "TitleRequired",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "TokenDoesNotExist",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "startPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "duration",
				"type": "uint256"
			}
		],
		"name": "auctionNFT",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "auctionSettlement",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "bid",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bidder",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "BidNewPrice",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "buyNFT",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "BuySuccessfullToken",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "cancelAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "CancelAuction",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "cancelSale",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "CancelSale",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "startPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "duration",
				"type": "uint256"
			}
		],
		"name": "ListForAuction",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "ListForSale",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "image",
				"type": "string"
			}
		],
		"name": "mintNewNFT",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "minter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "MintNFT",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Received",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "caller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RefundPending",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "saleNFT",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "caller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Settlement",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "WithdrawFees",
		"type": "event"
	},
	{
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"inputs": [],
		"name": "withdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawPendingReturns",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "auctionTokens",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "highestBidder",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "currentPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "endTime",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FEE_PERCENTAGE",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getMyTokens",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "image",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "enum MarketMedia.SaleType",
						"name": "saleType",
						"type": "uint8"
					},
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "listed",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "priceForSale",
						"type": "uint256"
					},
					{
						"components": [
							{
								"internalType": "address payable",
								"name": "highestBidder",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "currentPrice",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "endTime",
								"type": "uint256"
							}
						],
						"internalType": "struct MarketMedia.AuctionDetails",
						"name": "auctionDetails",
						"type": "tuple"
					}
				],
				"internalType": "struct MarketMedia.TokenView[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPendingFees",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getTokenDetail",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "image",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "enum MarketMedia.SaleType",
						"name": "saleType",
						"type": "uint8"
					},
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "listed",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "priceForSale",
						"type": "uint256"
					},
					{
						"components": [
							{
								"internalType": "address payable",
								"name": "highestBidder",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "currentPrice",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "endTime",
								"type": "uint256"
							}
						],
						"internalType": "struct MarketMedia.AuctionDetails",
						"name": "auctionDetails",
						"type": "tuple"
					}
				],
				"internalType": "struct MarketMedia.TokenView",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "pageNumber",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "limit",
				"type": "uint8"
			}
		],
		"name": "getTokenPage",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "image",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "enum MarketMedia.SaleType",
						"name": "saleType",
						"type": "uint8"
					},
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "listed",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "priceForSale",
						"type": "uint256"
					},
					{
						"components": [
							{
								"internalType": "address payable",
								"name": "highestBidder",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "currentPrice",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "endTime",
								"type": "uint256"
							}
						],
						"internalType": "struct MarketMedia.AuctionDetails",
						"name": "auctionDetails",
						"type": "tuple"
					}
				],
				"internalType": "struct MarketMedia.TokenView[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			}
		],
		"name": "getTokensByAddress",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "image",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "enum MarketMedia.SaleType",
						"name": "saleType",
						"type": "uint8"
					},
					{
						"internalType": "address",
						"name": "owner",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "listed",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "priceForSale",
						"type": "uint256"
					},
					{
						"components": [
							{
								"internalType": "address payable",
								"name": "highestBidder",
								"type": "address"
							},
							{
								"internalType": "uint256",
								"name": "currentPrice",
								"type": "uint256"
							},
							{
								"internalType": "uint256",
								"name": "endTime",
								"type": "uint256"
							}
						],
						"internalType": "struct MarketMedia.AuctionDetails",
						"name": "auctionDetails",
						"type": "tuple"
					}
				],
				"internalType": "struct MarketMedia.TokenView[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "MIN_AUCTION_DURATION",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "pendingReturns",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "salePrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "tokens",
		"outputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "image",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "enum MarketMedia.SaleType",
				"name": "saleType",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
const SALE_TYPE = {
        NOT_LISTED: 0,
        FIXED_PRICE: 1,
        AUCTION: 2
    };

    // ====================== BI·∫æN TO√ÄN C·ª§C ======================
    let provider, signer, contract, currentAccount = null, contractOwner = null;
    let currentNFTsData = []; // Cache d·ªØ li·ªáu NFT
    let currentModalNFTId = null;
    let currentPage = 1;
    const ITEMS_PER_PAGE = 6;

    const toggleMobileMenu = () => {
    const menu = document.getElementById('mobile-menu-drawer');
    const toggleBtn = document.getElementById('menu-toggle-btn');
    
    // Toggle class 'hidden'
    menu.classList.toggle('hidden');
    
    // Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng
    if (menu.classList.contains('hidden')) {
        toggleBtn.innerHTML = '&#9776;'; // Hamburger
        // C·∫ßn ƒë·∫£m b·∫£o r·∫±ng ch·ªâ n√∫t Explore c√≥ m√†u active ban ƒë·∫ßu
        document.querySelectorAll('.nav-item-mobile').forEach(btn => btn.classList.remove('text-neon-cyan', 'font-bold'));
        document.querySelector('.nav-item-mobile').classList.add('text-neon-cyan', 'font-bold');
    } else {
        toggleBtn.innerHTML = '&times;'; // D·∫•u X
    }
};

    // ====================== H√ÄM TI·ªÜN √çCH ======================
    const showLoading = (msg = "ƒêang ch·ªù x√°c nh·∫≠n giao d·ªãch Metamask...") => {
        const overlay = document.getElementById('loading-overlay');
        overlay.querySelector('p').textContent = msg;
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
    };

    const hideLoading = () => {
        document.getElementById('loading-overlay').classList.add('hidden');
        document.getElementById('loading-overlay').classList.remove('flex');
    };

    const shortenAddress = (addr) => addr ? `${addr.slice(0,6)}...${addr.slice(-4)}` : "N/A";

    const showMessage = (msg, isError = false) => {
        const box = document.getElementById('message-box');
        box.textContent = msg;
        box.className = `fixed bottom-8 right-8 px-6 py-4 rounded-lg font-bold text-card shadow-2xl z-[1100] animate-fade-in ${
            isError ? 'bg-danger-red' : 'bg-gradient-to-r from-neon-pink to-neon-cyan'
        }`;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 5000);
    };

    const formatEth = (wei, decimals = 4) => {
        if (!wei) return "0.0";
        try {
            let eth = ethers.utils.formatEther(wei);
            if (eth.includes('.')) {
                const parts = eth.split('.');
                // Gi·ªõi h·∫°n s·ªë ch·ªØ s·ªë th·∫≠p ph√¢n
                if (parts[1].length > decimals) eth = `${parts[0]}.${parts[1].substring(0, decimals)}`;
            }
            // Lo·∫°i b·ªè c√°c s·ªë 0 ·ªü cu·ªëi
            return parseFloat(eth).toString();
        } catch { return "0.0"; }
    };

    const formatTimeRemaining = (endTime) => {
        const ms = endTime * 1000 - Date.now();
        if (ms <= 0) return "ƒê√£ k·∫øt th√∫c";
        const s = Math.floor(ms / 1000);
        const d = Math.floor(s / 86400);
        const h = Math.floor((s % 86400) / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        
        let parts = [];
        if (d > 0) parts.push(`${d}d`);
        if (h > 0) parts.push(`${h}h`);
        if (m > 0 && d === 0) parts.push(`${m}m`);
        if (sec > 0 && d === 0 && h === 0 && m < 1) parts.push(`${sec}s`);
        
        return parts.length > 0 ? parts.join(' ') : 'V√†i gi√¢y';
    };

    const closeModal = (id) => {
        document.getElementById(id).classList.add('hidden');
        document.getElementById(id).classList.remove('flex');
        currentModalNFTId = null;
    };

    // ====================== C√ÅC H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU/GIAO DIÃ£CH (MOCKUP) ======================

    const updateBalanceDisplay = async () => {
        if (!currentAccount || !provider) return;
        try {
            const balanceWei = await provider.getBalance(currentAccount);
            document.getElementById('balance-display').textContent = `${formatEth(balanceWei, 4)} ETH`;
            document.getElementById('profile-address').textContent = shortenAddress(currentAccount);
        } catch (error) {
            console.error("L·ªói c·∫≠p nh·∫≠t s·ªë d∆∞:", error);
        }
    };

    const updateOwnerFeesDisplay = async () => {
        if (!currentAccount) return;
        try {
            const readOnly = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, provider);
            const feesWei = await readOnly.getPendingFees();
            const feesEth = formatEth(feesWei, 4);

            if (currentAccount.toLowerCase() === contractOwner.toLowerCase()) {
                document.getElementById('owner-fees').textContent = feesEth;
                document.getElementById('admin-fees-amount').textContent = feesEth;
                document.getElementById('fees-display').classList.remove('hidden');
                document.getElementById('nav-admin').classList.remove('hidden');
            } else {
                document.getElementById('fees-display').classList.add('hidden');
                document.getElementById('nav-admin').classList.add('hidden');
            }
        } catch (error) {
            console.error("L·ªói c·∫≠p nh·∫≠t ph√≠ ch·ªß s·ªü h·ªØu:", error);
        }
    };

    const withdrawFees = async () => {
        if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠", true);
        showLoading("ƒêang r√∫t ph√≠ t√≠ch l≈©y...");
        try {
            const tx = await contract.withdrawFees();
            await tx.wait();
            showMessage("R√∫t ph√≠ th√†nh c√¥ng!");
            await updateOwnerFeesDisplay();
        } catch (error) {
            showMessage("L·ªói r√∫t ph√≠: " + (error.data?.message || error.message), true);
        } finally {
            hideLoading();
        }
    };

    const loadNFTsForExplore = async () => {
        if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum || null);
        try {
            const readOnly = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, provider);
            const allTokens = await readOnly.getTokenPage(currentPage, ITEMS_PER_PAGE);
            currentNFTsData = allTokens; // Cache d·ªØ li·ªáu
            renderNFTs(allTokens, 'explore-grid', false);
        } catch (error) {
            console.error("L·ªói t·∫£i NFT Explore:", error);
            document.getElementById('explore-grid').innerHTML = '<p class="col-span-full text-center text-red-500 py-20 text-xl">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Marketplace. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† ABI.</p>';
        }
    };

    const loadNFTsForProfile = async () => {
        if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ xem Profile", true);
        try {
            const myTokens = await contract.getTokensByAddress(currentAccount);
            // C·∫≠p nh·∫≠t cache (c√≥ th·ªÉ merge v·ªõi allTokens n·∫øu c·∫ßn, nh∆∞ng t·∫°m th·ªùi ch·ªâ d√πng myTokens)
            console.log("My Tokens:", myTokens);
            currentNFTsData = myTokens; 
            renderNFTs(myTokens, 'profile-grid', true);
            await updatePendingReturnsDisplay();
        } catch (error) {
            console.error("L·ªói t·∫£i NFT Profile:", error);
            document.getElementById('profile-grid').innerHTML = '<p class="col-span-full text-center text-red-500 py-20 text-xl">L·ªói t·∫£i NFT c·ªßa b·∫°n. (C√≥ th·ªÉ b·∫°n ch∆∞a mint token n√†o.)</p>';
        }
    };

    const updatePendingReturnsDisplay = async () => {
        if (!currentAccount || !provider) return;
        try {
            const readOnly = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, provider);
            const returnsWei = await readOnly.pendingReturns(currentAccount);
            const returnsEth = formatEth(returnsWei, 4);

            if (returnsEth > 0) {
                document.getElementById('pending-return-amount').textContent = returnsEth;
                document.getElementById('return-info').classList.remove('hidden');
            } else {
                document.getElementById('return-info').classList.add('hidden');
            }
        } catch (error) {
            console.error("L·ªói c·∫≠p nh·∫≠t l·ª£i nhu·∫≠n ch·ªù r√∫t:", error);
        }
    };
    
    // *** C√ÅC H√ÄM GIAO D·ªäCH KH√ÅC (C·∫¶N T·ª∞ TH√äM LOGIC) ***
    // function showBuyModal(tokenId, price) { /* ... */ }
    // function showBidModal(tokenId) { /* ... */ }
    // function showCancelSaleModal(tokenId) { /* ... */ }
    // function showSellFixedModal(tokenId) { /* ... */ }
    // function showSellAuctionModal(tokenId) { /* ... */ }
    // function showSettlementModal(tokenId) { /* ... */ }

    // ====================== H√ÄM HI·ªÇN TH·ªä MODAL H√ÄNH ƒê·ªòNG ƒêA NƒÇNG ======================

const renderActionModal = (title, contentHTML) => {
    const modal = document.getElementById('actionModal');
    if (!modal) return showMessage("L·ªói c·∫•u h√¨nh Modal.", true);

    document.getElementById('actionModalTitle').textContent = title;
    document.getElementById('actionModalContent').innerHTML = contentHTML;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
};

// ====================== C√ÅC H√ÄM GIAO D·ªäCH (ƒê∆Ø·ª¢C TRI·ªÇN KHAI) ======================

const showBuyModal = (tokenId, price) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ mua", true);

    const contentHTML = `
        <p class="text-lg mb-6">B·∫°n ƒëang chu·∫©n b·ªã mua NFT Token ID: <span class="font-bold text-neon-pink">${tokenId}</span>.</p>
        <p class="text-3xl font-extrabold text-neon-green mb-8">Gi√°: ${price} ETH</p>
        
        <button onclick="handleBuyNFT(${tokenId}, '${price}')" 
            class="w-full btn-neon bg-gradient-to-r from-neon-green to-neon-cyan py-4 rounded-lg font-bold text-card text-xl shadow-neon-green hover:scale-105 transition">
            X√°c nh·∫≠n Mua
        </button>
    `;

    renderActionModal(`MUA NFT`, contentHTML);
};

const handleBuyNFT = async (tokenId, priceEth) => {
    closeModal('actionModal');
    showLoading("ƒêang mua NFT...");
    
    try {
        const priceWei = ethers.utils.parseEther(priceEth);
        // GI·∫¢ ƒê·ªäNH h√†m mua trong contract l√† buyNFT, c·∫ßn g·ª≠i k√®m value (gi√° tr·ªã ETH)
        const tx = await contract.buyNFT(tokenId, { value: priceWei });
        await tx.wait();
        showMessage(`Mua Token ID ${tokenId} th√†nh c√¥ng!`);
        // T·∫£i l·∫°i d·ªØ li·ªáu sau giao d·ªãch
        await loadNFTsForExplore(); 
    } catch (error) {
        showMessage("L·ªói mua NFT: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};

const showBidModal = (tokenId) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ ƒë·∫∑t Bid", true);
    
    // L·∫•y th√¥ng tin NFT ƒë·ªÉ ki·ªÉm tra gi√° t·ªëi thi·ªÉu n·∫øu c·∫ßn
    const nft = currentNFTsData.find(n => n[0].toString() === tokenId.toString());
    const minBid = nft ? formatEth(nft[8][1], 4) : '0.0'; // nft[8][1] l√† currentBid
    
    const contentHTML = `
        <p class="text-lg mb-4">Token ID: <span class="font-bold text-neon-pink">${tokenId}</span></p>
        <p class="text-md text-gray-400 mb-6">Gi√° bid hi·ªán t·∫°i: ${minBid} ETH</p>
        
        <form id="bid-form">
            <label class="block text-neon-cyan mb-2">S·ªë ETH mu·ªën Bid</label>
            <input type="number" step="0.0001" min="${minBid}" id="bid-amount" required 
                class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" 
                placeholder="V√≠ d·ª•: ${parseFloat(minBid) + 0.01}">
            
            <button type="submit" 
                class="w-full btn-neon bg-gradient-to-r from-neon-blue to-neon-cyan py-4 rounded-lg font-bold text-card text-xl mt-6 shadow-neon hover:scale-105 transition">
                X√°c nh·∫≠n ƒê·∫∑t Bid
            </button>
        </form>
    `;

    renderActionModal(`ƒê·∫∂T BID ƒê·∫•u Gi√°`, contentHTML);

    document.getElementById('bid-form').onsubmit = (e) => {
        e.preventDefault();
        const bidAmount = document.getElementById('bid-amount').value;
        handlePlaceBid(tokenId, bidAmount);
    };
};

const handlePlaceBid = async (tokenId, bidAmountEth) => {
    closeModal('actionModal');
    showLoading("ƒêang g·ª≠i Bid...");
    
    try {
        const bidAmountWei = ethers.utils.parseEther(bidAmountEth);
        // GI·∫¢ ƒê·ªäNH h√†m ƒë·∫∑t bid trong contract l√† placeBid, c·∫ßn g·ª≠i k√®m value
        const tx = await contract.bid(tokenId, { value: bidAmountWei });
        await tx.wait();
        showMessage(`ƒê·∫∑t Bid ${bidAmountEth} ETH cho Token ID ${tokenId} th√†nh c√¥ng!`);
        await loadNFTsForExplore();
    } catch (error) {
        showMessage("L·ªói ƒë·∫∑t Bid: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};

const showSellFixedModal = (tokenId) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ ni√™m y·∫øt", true);

    const contentHTML = `
        <p class="text-lg mb-6">Ni√™m y·∫øt Token ID: <span class="font-bold text-neon-pink">${tokenId}</span> v·ªõi gi√° c·ªë ƒë·ªãnh.</p>
        <form id="fixed-sale-form">
            <label class="block text-neon-cyan mb-2">Gi√° B√°n (ETH)</label>
            <input type="number" step="0.0001" min="0.0001" id="sale-price" required 
                class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" 
                placeholder="V√≠ d·ª•: 0.5">
            
            <button type="submit" 
                class="w-full btn-neon bg-gradient-to-r from-neon-green to-neon-pink py-4 rounded-lg font-bold text-card text-xl mt-6 shadow-neon-green hover:scale-105 transition">
                Ni√™m Y·∫øt Fixed Price
            </button>
        </form>
    `;

    renderActionModal(`NI√äM Y·∫æT B√ÅN C·ªê ƒê·ªäNH`, contentHTML);

    document.getElementById('fixed-sale-form').onsubmit = (e) => {
        e.preventDefault();
        const price = document.getElementById('sale-price').value;
        handleListFixedPrice(tokenId, price);
    };
};

const handleListFixedPrice = async (tokenId, priceEth) => {
    closeModal('actionModal');
    showLoading("ƒêang ni√™m y·∫øt NFT...");
    
    try {
        const priceWei = ethers.utils.parseEther(priceEth);
        // GI·∫¢ ƒê·ªäNH h√†m ni√™m y·∫øt l√† listFixedPrice
        const tx = await contract.saleNFT(tokenId, priceWei);
        await tx.wait();
        showMessage(`Ni√™m y·∫øt Token ID ${tokenId} v·ªõi gi√° ${priceEth} ETH th√†nh c√¥ng!`);
        await loadNFTsForProfile();
        showPage('explore'); // Chuy·ªÉn v·ªÅ trang explore ƒë·ªÉ th·∫•y NFT
    } catch (error) {
        showMessage("L·ªói ni√™m y·∫øt: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};

const showSellAuctionModal = (tokenId) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ ƒë·∫•u gi√°", true);

    const contentHTML = `
        <p class="text-lg mb-6">B·∫Øt ƒë·∫ßu ƒë·∫•u gi√° Token ID: <span class="font-bold text-neon-pink">${tokenId}</span></p>
        <form id="auction-sale-form" class="space-y-4">
            <div>
                <label class="block text-neon-cyan mb-2">Gi√° Kh·ªüi ƒêi·ªÉm (ETH)</label>
                <input type="number" step="0.0001" min="0.0001" id="auction-start-price" required 
                    class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" 
                    placeholder="V√≠ d·ª•: 0.1">
            </div>
            <div>
                <label class="block text-neon-cyan mb-2">Th·ªùi Gian ƒê·∫•u Gi√° (Ng√†y)</label>
                <input type="number" min="1" max="30" id="auction-duration-days" required 
                    class="w-full px-5 py-4 bg-accent/50 border border-border-glow rounded-lg focus:border-neon-cyan focus:outline-none transition" 
                    placeholder="V√≠ d·ª•: 7">
            </div>
            
            <button type="submit" 
                class="w-full btn-neon bg-gradient-to-r from-neon-blue to-neon-pink py-4 rounded-lg font-bold text-card text-xl mt-6 shadow-neon-blue hover:scale-105 transition">
                B·∫Øt ƒê·∫ßu ƒê·∫•u Gi√°
            </button>
        </form>
    `;

    renderActionModal(`B·∫ÆT ƒê·∫¶U ƒê·∫§U GI√Å`, contentHTML);

    document.getElementById('auction-sale-form').onsubmit = (e) => {
        e.preventDefault();
        const startPrice = document.getElementById('auction-start-price').value;
        const durationDays = document.getElementById('auction-duration-days').value;
        handleListAuction(tokenId, startPrice, durationDays);
    };
};

const handleListAuction = async (tokenId, startPriceEth, durationDays) => {
    closeModal('actionModal');
    showLoading("ƒêang t·∫°o phi√™n ƒë·∫•u gi√°...");
    
    try {
        const startPriceWei = ethers.utils.parseEther(startPriceEth);
        // Chuy·ªÉn ƒë·ªïi ng√†y th√†nh gi√¢y (1 ng√†y = 86400 gi√¢y)
        const durationSeconds = durationDays * 86400; 
        
        // GI·∫¢ ƒê·ªäNH h√†m ni√™m y·∫øt l√† listAuction
        const tx = await contract.auctionNFT(tokenId, startPriceWei, durationSeconds);
        await tx.wait();
        showMessage(`T·∫°o ƒë·∫•u gi√° Token ID ${tokenId} th√†nh c√¥ng, k√©o d√†i ${durationDays} ng√†y!`);
        await loadNFTsForProfile();
        showPage('explore'); 
    } catch (error) {
        showMessage("L·ªói t·∫°o ƒë·∫•u gi√°: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};


const showCancelSaleModal = (tokenId) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠", true);

    const contentHTML = `
        <p class="text-xl mb-8 text-center text-danger-red font-bold">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y ni√™m y·∫øt Token ID: ${tokenId}?</p>
        <p class="text-md mb-6 text-gray-400 text-center">NFT s·∫Ω kh√¥ng c√≤n hi·ªÉn th·ªã tr√™n Marketplace.</p>
        
        <button onclick="handleCancelSale(${tokenId})" 
            class="w-full btn-neon bg-danger-red py-4 rounded-lg font-bold text-card text-xl shadow-danger-red hover:scale-105 transition">
            X√°c nh·∫≠n H·ª¶Y B√ÅN
        </button>
    `;

    renderActionModal(`H·ª¶Y NI√äM Y·∫æT`, contentHTML);
};

const handleCancelSale = async (tokenId) => {
    closeModal('actionModal');
    showLoading("ƒêang h·ªßy ni√™m y·∫øt...");
    
    try {
        // GI·∫¢ ƒê·ªäNH h√†m h·ªßy l√† cancelSale
        const tx = await contract.cancelSale(tokenId);
        await tx.wait();
        showMessage(`H·ªßy ni√™m y·∫øt Token ID ${tokenId} th√†nh c√¥ng!`);
        await loadNFTsForProfile();
    } catch (error) {
        showMessage("L·ªói h·ªßy ni√™m y·∫øt: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};

const showSettlementModal = (tokenId) => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠", true);

    const contentHTML = `
        <p class="text-xl mb-8 text-center text-neon-pink font-bold">Ho√†n t·∫•t giao d·ªãch ƒë·∫•u gi√° (Settlement) cho Token ID: ${tokenId}</p>
        <p class="text-md mb-6 text-gray-400 text-center">H√†nh ƒë·ªông n√†y s·∫Ω chuy·ªÉn NFT cho ng∆∞·ªùi tr·∫£ gi√° cao nh·∫•t v√† chuy·ªÉn ETH cho ch·ªß s·ªü h·ªØu.</p>
        
        <button onclick="handleSettlement(${tokenId})" 
            class="w-full btn-neon bg-neon-pink py-4 rounded-lg font-bold text-card text-xl shadow-neon-pink hover:scale-105 transition">
            X√°c nh·∫≠n Settlement
        </button>
    `;

    renderActionModal(`SETTLEMENT ƒê·∫•u Gi√°`, contentHTML);
};

const handleSettlement = async (tokenId) => {
    closeModal('actionModal');
    showLoading("ƒêang ho√†n t·∫•t ƒë·∫•u gi√°...");
    
    try {
        // GI·∫¢ ƒê·ªäNH h√†m ho√†n t·∫•t ƒë·∫•u gi√° l√† settleAuction
        const tx = await contract.auctionSettlement(tokenId);
        await tx.wait();
        showMessage(`Settlement Token ID ${tokenId} th√†nh c√¥ng!`);
        await loadNFTsForProfile(); // C·∫≠p nh·∫≠t Profile (ch·ªß s·ªü h·ªØu c≈© m·∫•t NFT)
        await loadNFTsForExplore(); // C·∫≠p nh·∫≠t Explore (NFT kh√¥ng c√≤n ƒë·∫•u gi√°)
    } catch (error) {
        showMessage("L·ªói Settlement: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};

const withdrawPendingReturns = async () => {
    if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠", true);
    showLoading("ƒêang r√∫t ETH...");
    try {
        // GI·∫¢ ƒê·ªäNH h√†m r√∫t ETH cho ng∆∞·ªùi b√°n v√† ng∆∞·ªùi ƒë·∫∑t bid thua l√† withdraw
        const tx = await contract.withdrawPendingReturns();
        await tx.wait();
        showMessage("R√∫t ETH th√†nh c√¥ng!");
        await updatePendingReturnsDisplay();
        await updateBalanceDisplay();
    } catch (error) {
        showMessage("L·ªói r√∫t ETH: " + (error.data?.message || error.message || error.reason), true);
    } finally {
        hideLoading();
    }
};


    // ====================== CHUY·ªÇN TRANG & RENDER ======================

    const showPage = (pageId) => {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.classList.remove('text-neon-cyan', 'font-bold', 'border-b-2', 'border-neon-cyan');
            btn.classList.add('text-white/70');
        });
        const activeNav = document.getElementById(`nav-${pageId}`);
        if(activeNav) {
            activeNav.classList.add('text-neon-cyan', 'font-bold');
            activeNav.classList.remove('text-white/70');
        }

        if (pageId === 'explore') {
            loadNFTsForExplore();
        } else if (pageId === 'profile') {
            if (currentAccount) loadNFTsForProfile();
            else document.getElementById('profile-grid').innerHTML = '<p class="col-span-full text-center text-gray-500 py-20 text-xl">Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ xem NFT c·ªßa b·∫°n.</p>';
        } else if (pageId === 'admin') {
            if (currentAccount && contractOwner && currentAccount.toLowerCase() === contractOwner.toLowerCase()) updateOwnerFeesDisplay();
            else showPage('explore'); // Ch·∫∑n truy c·∫≠p n·∫øu kh√¥ng ph·∫£i owner
        }
    };


    const createNFTCard = (nft, isProfile = false) => {
        // C·∫•u tr√∫c token: [tokenId, title, image, lastSoldPriceWei, saleType, ownerAddress, listed, priceForSaleWei, auctionDetails]
        const [
            tokenId, title, image, lastSoldPriceWei, saleType,
            ownerAddress, , priceForSaleWei, auctionDetails
        ] = nft;

        const tokenIdStr = tokenId.toString();
        const isMyNFT = currentAccount && ownerAddress.toLowerCase() === currentAccount.toLowerCase();

        let priceDisplay = '', priceColor = '', statusTag = '', actionButtons = '';

        // --- Logic Hi·ªÉn Th·ªã Gi√° & Tr·∫°ng th√°i ---
        if (saleType === SALE_TYPE.FIXED_PRICE) {
            const priceEth = formatEth(priceForSaleWei, 4);
            priceDisplay = `${priceEth} ETH`;
            priceColor = 'text-neon-green';
            statusTag = '<span class="tag px-3 py-1 rounded-full bg-neon-green text-card text-xs font-bold">Fixed Price</span>';

            if (!isMyNFT && currentAccount) {
                actionButtons = `<button class="btn-neon bg-neon-green w-full py-3 rounded-lg font-bold text-card hover:scale-[1.03] transition" onclick="showBuyModal(${tokenIdStr}, '${priceEth}')">MUA NGAY</button>`;
            } else if (isMyNFT && isProfile) {
                actionButtons = `<button class="btn-neon bg-danger-red w-full py-3 rounded-lg font-bold text-card hover:scale-[1.03] transition" onclick="showCancelSaleModal(${tokenIdStr})">H·ª¶Y B√ÅN</button>`;
            }

        } else if (saleType === SALE_TYPE.AUCTION) {
            const currentBid = formatEth(auctionDetails[1], 4);
            const endTime = auctionDetails[2].toNumber();
            const isEnded = endTime <= Date.now() / 1000;

            priceDisplay = `${currentBid} ETH`;
            priceColor = isEnded ? 'text-danger-red' : 'text-neon-blue';

            if (isEnded) {
                statusTag = '<span class="tag px-3 py-1 rounded-full bg-danger-red text-card text-xs font-bold">ƒê√£ K·∫øt Th√∫c</span>';
                if (isMyNFT && auctionDetails[0] !== ethers.constants.AddressZero) {
                    actionButtons = `<button class="btn-neon bg-neon-pink w-full py-3 rounded-lg font-bold text-card hover:scale-[1.03] transition" onclick="event.stopPropagation(); showSettlementModal(${tokenIdStr})">SETTLEMENT</button>`;
                }
            } else {
                statusTag = `<span class="tag px-3 py-1 rounded-full bg-neon-blue text-card text-xs font-bold">Auction</span>
                              <span class="text-neon-cyan text-sm ml-2">${formatTimeRemaining(endTime)}</span>`;
                if (!isMyNFT && currentAccount) {
                    actionButtons = `<button class="btn-neon bg-neon-blue w-full py-3 rounded-lg font-bold text-card hover:scale-[1.03] transition" onclick="event.stopPropagation(); showBidModal(${tokenIdStr})">ƒê·∫∂T BID</button>`;
                }
            }

        } else { // NOT LISTED
            const lastPrice = formatEth(lastSoldPriceWei, 4);
            priceDisplay = lastPrice === '0' ? 'Ch∆∞a m·ªü b√°n' : `${lastPrice} ETH`;
            priceColor = 'text-gray-400';
            statusTag = '<span class="tag px-3 py-1 rounded-full bg-gray-600 text-white text-xs font-bold">Not Listed</span>';

            if (isMyNFT && isProfile) {
                actionButtons = `
                    <div class="grid grid-cols-2 gap-3">
                        <button class="btn-neon bg-neon-green text-card py-3 rounded-lg font-bold hover:scale-[1.03] transition" onclick="event.stopPropagation(); showSellFixedModal(${tokenIdStr})">Fixed</button>
                        <button class="btn-neon bg-neon-blue text-card py-3 rounded-lg font-bold hover:scale-[1.03] transition" onclick="event.stopPropagation(); showSellAuctionModal(${tokenIdStr})">Auction</button>
                    </div>`;
            }
        }

        return `
            <div class="nft-card bg-card border border-border-glow rounded-2xl overflow-hidden shadow-card cursor-pointer transform transition-all duration-500 hover:shadow-neon"
                    onclick="showNFTDetailsModal('${tokenIdStr}')">
                <img src="${image}" alt="${title}" class="nft-image w-full h-64 object-cover border-b border-border-glow">
                <div class="p-6 flex flex-col justify-between h-auto">
                    <div>
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-bold text-neon-pink truncate">${title}</h3>
                            <span class="text-xs text-gray-500">ID: ${tokenIdStr}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">
                            Owner: <span class="${isMyNFT ? 'text-neon-pink font-bold' : 'text-gray-300'}">${isMyNFT ? 'B·∫°n' : shortenAddress(ownerAddress)}</span>
                        </p>
                        <div class="mb-4">${statusTag}</div>
                        <p class="text-3xl font-extrabold ${priceColor} mb-6">${priceDisplay}</p>
                    </div>
                    <div>${actionButtons}</div>
                </div>
            </div>`;
    };

    const renderNFTs = (nfts, gridId, isProfile = false) => {
        const grid = document.getElementById(gridId);
        grid.innerHTML = ''; // X√≥a n·ªôi dung c≈©

        const filtered =  nfts;

        if (filtered.length === 0) {
            grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-20 text-xl">
                ${isProfile ? 'B·∫°n ch∆∞a s·ªü h·ªØu NFT n√†o.' : 'Marketplace hi·ªán ch∆∞a c√≥ NFT n√†o ƒë∆∞·ª£c ni√™m y·∫øt.'}
            </p>`;
            return;
        }

        grid.innerHTML = filtered.map(nft => createNFTCard(nft, isProfile)).join('');
    };

    // ====================== MODAL CHI TI·∫æT NFT ======================
    const showNFTDetailsModal = async (tokenId) => {
        const nft = currentNFTsData.find(n => n[0].toString() === tokenId);
        if (!nft) return showMessage("Kh√¥ng t√¨m th·∫•y NFT n√†y", true);

        const [tokenIdBN, title, image, lastSoldPriceWei, saleType, ownerAddress, , priceForSaleWei, auctionDetails] = nft;
        const isMyNFT = currentAccount && ownerAddress.toLowerCase() === currentAccount.toLowerCase();
        
        // C·∫≠p nh·∫≠t c√°c element c∆° b·∫£n
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalImage').src = image;
        document.getElementById('modalTokenId').textContent = tokenId;
        document.getElementById('modalOwner').textContent = isMyNFT ? 'B·∫°n' : shortenAddress(ownerAddress);
        document.getElementById('modalLastPrice').textContent = formatEth(lastSoldPriceWei, 4) + ' ETH';

        let statusEl = document.getElementById('modalStatus');
        let priceEl = document.getElementById('modalCurrentPrice');
        let actionsDiv = document.getElementById('modalActions');
        let auctionDiv = document.getElementById('modalAuctionDetails');
        document.getElementById('modalTimeRemaining').textContent = '';

        // --- Logic Hi·ªÉn Th·ªã Gi√° & Tr·∫°ng th√°i Modal ---
        if (saleType === SALE_TYPE.FIXED_PRICE) {
            const price = formatEth(priceForSaleWei, 4);
            priceEl.textContent = `${price} ETH`;
            priceEl.className = 'text-5xl font-extrabold text-neon-green';
            statusEl.textContent = 'Fixed Price';
            statusEl.className = 'tag px-4 py-2 rounded-full bg-neon-green text-card font-bold';
            auctionDiv.classList.add('hidden');

            actionsDiv.innerHTML = !isMyNFT && currentAccount
                ? `<button class="btn-neon bg-neon-green w-full py-4 rounded-lg font-bold text-card text-xl shadow-neon-green hover:scale-105 transition" onclick="showBuyModal(${tokenId}, '${price}')">MUA NGAY</button>`
                : isMyNFT
                    ? `<button class="btn-neon bg-danger-red w-full py-4 rounded-lg font-bold text-card text-xl hover:scale-105 transition" onclick="showCancelSaleModal(${tokenId})">H·ª¶Y B√ÅN</button>`
                    : `<button class="btn-neon bg-gray-600 w-full py-4 rounded-lg font-bold text-white cursor-not-allowed">Kh√¥ng c√≥ h√†nh ƒë·ªông</button>`;

        } else if (saleType === SALE_TYPE.AUCTION) {
            const bid = formatEth(auctionDetails[1], 4);
            const endTime = auctionDetails[2].toNumber();
            const ended = endTime <= Date.now() / 1000;
            const highestBidder = auctionDetails[0];

            priceEl.textContent = `${bid} ETH`;
            priceEl.className = ended ? 'text-5xl font-extrabold text-danger-red' : 'text-5xl font-extrabold text-neon-blue';
            statusEl.textContent = ended ? 'ƒê√£ K·∫øt Th√∫c' : 'Auction Live';
            statusEl.className = ended ? 'tag px-4 py-2 rounded-full bg-danger-red text-card font-bold' : 'tag px-4 py-2 rounded-full bg-neon-blue text-card font-bold';

            document.getElementById('modalHighestBidder').textContent = shortenAddress(highestBidder);
            document.getElementById('modalEndTime').textContent = new Date(endTime * 1000).toLocaleString();
            document.getElementById('modalTimeRemaining').textContent = ended ? '' : ` (${formatTimeRemaining(endTime)})`;
            auctionDiv.classList.remove('hidden');

            if (!ended && !isMyNFT && currentAccount) {
                actionsDiv.innerHTML = `<button class="btn-neon bg-neon-blue w-full py-4 rounded-lg font-bold text-card text-xl shadow-neon hover:scale-105 transition" onclick="showBidModal(${tokenId})">ƒê·∫∂T BID</button>`;
            } else if (ended && isMyNFT && highestBidder !== ethers.constants.AddressZero) {
                actionsDiv.innerHTML = `<button class="btn-neon bg-neon-pink w-full py-4 rounded-lg font-bold text-card text-xl shadow-neon-pink hover:scale-105 transition" onclick="showSettlementModal(${tokenId})">SETTLEMENT</button>`;
            } else {
                actionsDiv.innerHTML = `<button class="btn-neon bg-gray-600 w-full py-4 rounded-lg font-bold text-white cursor-not-allowed">${ended ? 'ƒê√£ K·∫øt Th√∫c' : 'ƒêang ƒê·∫•u Gi√°'}</button>`;
            }

        } else { // NOT_LISTED
            const last = formatEth(lastSoldPriceWei, 4);
            priceEl.textContent = last === '0' ? 'Ch∆∞a m·ªü b√°n' : `${last} ETH`;
            priceEl.className = 'text-5xl font-extrabold text-gray-400';
            statusEl.textContent = 'Not Listed';
            statusEl.className = 'tag px-4 py-2 rounded-full bg-gray-600 text-white font-bold';
            auctionDiv.classList.add('hidden');

            actionsDiv.innerHTML = isMyNFT
                ? `<div class="grid grid-cols-2 gap-4">
                        <button class="btn-neon bg-neon-green text-card py-4 rounded-lg font-bold text-xl hover:scale-105 transition" onclick="showSellFixedModal(${tokenId})">Fixed Price</button>
                        <button class="btn-neon bg-neon-blue text-card py-4 rounded-lg font-bold text-xl hover:scale-105 transition" onclick="showSellAuctionModal(${tokenId})">Auction</button>
                    </div>`
                : `<button class="btn-neon bg-gray-600 w-full py-4 rounded-lg font-bold text-white cursor-not-allowed">Kh√¥ng c√≥ h√†nh ƒë·ªông</button>`;
        }

        // Hi·ªÉn th·ªã Modal
        document.getElementById('nftDetailModal').classList.remove('hidden');
        document.getElementById('nftDetailModal').classList.add('flex');
    };


    // ====================== K·∫æT N·ªêI V√ç ======================
    const connectWallet = async () => {
        if (!window.ethereum) return showMessage("C·∫ßn c√†i Metamask!", true);

        try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];

            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, signer);

            const readOnly = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, provider);
            contractOwner = await readOnly.owner();

            document.getElementById('connect-wallet-btn').classList.add('hidden');
            document.getElementById('wallet-info').classList.remove('hidden');
            document.getElementById('account-display').textContent = shortenAddress(currentAccount);

            await updateBalanceDisplay();
            await updateOwnerFeesDisplay();
            showMessage("K·∫øt n·ªëi v√≠ th√†nh c√¥ng!");

            // Chuy·ªÉn sang trang ƒëang active, ho·∫∑c Explore n·∫øu l·∫ßn ƒë·∫ßu
            const activeNavElement = document.querySelector('.nav-item.text-neon-cyan');
            const activePage = activeNavElement ? activeNavElement.id.replace('nav-', '') : 'explore';
            showPage(activePage);

        } catch (err) {
            showMessage("K·∫øt n·ªëi th·∫•t b·∫°i: " + (err.message || "K·∫øt n·ªëi b·ªã t·ª´ ch·ªëi."), true);
        }
    };

    const toggleWalletConnection = () => currentAccount ? (() => {
        currentAccount = null; contract = null;
        document.getElementById('connect-wallet-btn').classList.remove('hidden');
        document.getElementById('wallet-info').classList.add('hidden');
        document.getElementById('fees-display').classList.add('hidden');
        showMessage("ƒê√£ ng·∫Øt k·∫øt n·ªëi v√≠");
        showPage('explore');
    })() : connectWallet();

    // ====================== KH·ªûI T·∫†O ======================
    document.addEventListener('DOMContentLoaded', () => {
        // T·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i n·∫øu Metamask ƒë√£ k·∫øt n·ªëi tr∆∞·ªõc ƒë√≥
        if (window.ethereum && window.ethereum.selectedAddress) {
             connectWallet();
        } else {
             showPage('explore');
        }

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', accounts => accounts.length ? connectWallet() : toggleWalletConnection());
            window.ethereum.on('chainChanged', () => location.reload());
        }
        
        // G·∫Øn listener cho Mint form
        document.getElementById('mint-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!contract) return showMessage("Vui l√≤ng k·∫øt n·ªëi v√≠ ƒë·ªÉ Mint", true);
            
            const title = document.getElementById('nft-title').value;
            const image = document.getElementById('nft-image').value;
            
            showLoading("ƒêang Mint NFT...");
            try {
                const tx = await contract.mintNewNFT(title, image);
                await tx.wait();
                showMessage(`Mint NFT "${title}" th√†nh c√¥ng!`);
                document.getElementById('mint-form').reset();
            } catch (error) {
                showMessage("L·ªói Mint NFT: " + (error.data?.message || error.message), true);
            } finally {
                hideLoading();
            }
        });
    });

</script>
</body>
</html>